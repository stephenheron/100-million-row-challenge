name: Run Benchmarks

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to benchmark"
        required: true
        type: string

concurrency:
  group: run-benchmarks
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  run_benchmarks:
    environment: benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ inputs.pr_number }}/head
          fetch-depth: 0

      - name: Print benchmark target (PR + commit)
        shell: bash
        run: |
          echo "Benchmarking PR #${{ inputs.pr_number }}"
          echo "Checked out commit: $(git rev-parse HEAD)"
          echo "Checked out ref:    $(git symbolic-ref -q --short HEAD || echo 'DETACHED_HEAD')"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.5
          extensions: mbstring, pcntl, fileinfo, zip

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction --ignore-platform-reqs

      # Validate in the action so that we have instant failure
      - name: Validate Solution
        run: php ./tempest data:validate

      # Running the benchmark on the server
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: "just-a-placeholder-so-we-dont-get-errors"

      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Get PR title (base64)
        id: pr
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const prNumber = Number('${{ inputs.pr_number }}');
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // Normalize to a single line, then base64-encode for safe transport into SSH
            const title = String(pr.title ?? '').replace(/\r?\n/g, ' ').trim();
            const titleB64 = Buffer.from(title, 'utf8').toString('base64');

            core.setOutput('title_b64', titleB64);

      - name: Determine branch + fetch ref
        shell: bash
        run: |
          echo "BRANCH=pr-${{ inputs.pr_number }}" >> "$GITHUB_ENV"
          echo "FETCH_REF=refs/pull/${{ inputs.pr_number }}/head" >> "$GITHUB_ENV"
          echo "PR_TITLE_B64=${{ steps.pr.outputs.title_b64 }}" >> "$GITHUB_ENV"

      - name: Checkout code on server
        shell: bash
        run: |
          ssh "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "bash -lc '
            set -euo pipefail
            cd ~/benchmark
          
            git fetch --prune origin
            
            git reset --hard
            git clean -fd
            
            git checkout -f main
            git reset --hard origin/main
            git clean -fd
            
            git branch -D \"$BRANCH\" 2>/dev/null || true
            git fetch origin \"$FETCH_REF:$BRANCH\"
            git checkout -f \"$BRANCH\"
            
            git reset --hard
            git clean -fd
          '"

      - name: Run benchmark
        run: |
          ssh "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "bash -lc '
            set -euo pipefail
            cd ~/benchmark
          
            php8.5 /usr/local/bin/composer install --no-dev
            
            rm -r /home/forge/benchmark/.tempest
            php8.5 tempest cache:clear --force
            php8.5 tempest discovery:generate

            PR_TITLE=\$(printf \"%s\" \"$PR_TITLE_B64\" | base64 --decode)
            php8.5 tempest data:parse --inputPath=\"/home/forge/data/real-data.csv\" --outputPath=\"/home/forge/data/real-data.json\" --store --name=\"\$PR_TITLE\"

            php8.5 tempest data:verify --actualPath=\"/home/forge/data/real-data.json\" --expectedPath=\"/home/forge/data/real-data-expected.json\"
        
            ENTRY=\$(tail -n 1 leaderboard.csv)

            git reset --hard

            git fetch origin main
            git checkout main
            git pull --ff-only origin main

            echo \"\$ENTRY\" >> leaderboard.csv
            rm -r /home/forge/benchmark/.tempest
            php8.5 tempest cache:clear --force
            php8.5 tempest discovery:generate
            php8.5 tempest leaderboard:format
            git add leaderboard.csv
  
            git commit -m '\''Update leaderboard'\'' || true
  
            git push origin main
          '"

      - name: Comment on PR with benchmark run link
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ inputs.pr_number }}');
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const status = '${{ job.status }}';

            const body = [
              `Benchmarks finished with **${status}**.`,
              ``,
              `Workflow run: ${runUrl}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });